<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>CMS Debug - Shallow Bay Advisors</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #1E3A5F;
        }
        .success { border-left-color: #10B981; }
        .error { border-left-color: #EF4444; }
        .warning { border-left-color: #F59E0B; }
        h1 { color: #1E3A5F; }
        h2 { color: #374151; margin-top: 0; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .test-result { margin: 5px 0; }
        .pass { color: #10B981; font-weight: bold; }
        .fail { color: #EF4444; font-weight: bold; }
    </style>
</head>
<body>
    <h1>🔍 CMS Debug Page - Shallow Bay Advisors</h1>

    <div class="debug-section">
        <h2>🌐 Environment Check</h2>
        <div id="env-check">Running tests...</div>
    </div>

    <div class="debug-section">
        <h2>📁 File Access Check</h2>
        <div id="file-check">Checking files...</div>
    </div>

    <div class="debug-section">
        <h2>🔐 Identity Check</h2>
        <div id="identity-check">Checking authentication...</div>
    </div>

    <div class="debug-section">
        <h2>⚙️ Git Gateway Check</h2>
        <div id="gateway-check">Checking Git Gateway...</div>
    </div>

    <div class="debug-section">
        <h2>📋 CMS Config Check</h2>
        <div id="config-check">Loading configuration...</div>
    </div>

    <div class="debug-section">
        <h2>🚀 Quick Fix</h2>
        <p>If all checks pass but CMS still doesn't work:</p>
        <button onclick="clearAllCache()" style="background: #1E3A5F; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
            Clear All Cache & Reload
        </button>
        <br><br>
        <a href="/admin/" style="background: #10B981; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">
            Try CMS Again
        </a>
    </div>

    <script>
        // Test environment
        function testEnvironment() {
            const results = [];

            // Check if we're on HTTPS
            results.push({
                test: 'HTTPS Protocol',
                pass: location.protocol === 'https:',
                details: `Protocol: ${location.protocol}`
            });

            // Check domain
            results.push({
                test: 'Correct Domain',
                pass: location.hostname === 'shabay.netlify.app',
                details: `Domain: ${location.hostname}`
            });

            // Check if we're on Netlify
            results.push({
                test: 'Netlify Environment',
                pass: location.hostname.includes('netlify.app'),
                details: `Is Netlify: ${location.hostname.includes('netlify.app')}`
            });

            displayResults('env-check', results);
        }

        // Test file access
        async function testFiles() {
            const results = [];

            try {
                const configResponse = await fetch('/admin/config.yml');
                results.push({
                    test: 'Config File Access',
                    pass: configResponse.ok,
                    details: `Status: ${configResponse.status} ${configResponse.statusText}`
                });
            } catch (e) {
                results.push({
                    test: 'Config File Access',
                    pass: false,
                    details: `Error: ${e.message}`
                });
            }

            try {
                const indexResponse = await fetch('/admin/index.html');
                results.push({
                    test: 'Admin Index Access',
                    pass: indexResponse.ok,
                    details: `Status: ${indexResponse.status} ${indexResponse.statusText}`
                });
            } catch (e) {
                results.push({
                    test: 'Admin Index Access',
                    pass: false,
                    details: `Error: ${e.message}`
                });
            }

            displayResults('file-check', results);
        }

        // Test Netlify Identity
        function testIdentity() {
            const results = [];

            // Check if Identity widget is loaded
            results.push({
                test: 'Identity Widget Loaded',
                pass: typeof window.netlifyIdentity !== 'undefined',
                details: `netlifyIdentity available: ${typeof window.netlifyIdentity !== 'undefined'}`
            });

            // Check Identity endpoint
            results.push({
                test: 'Identity Endpoint',
                pass: true,
                details: `Expected: ${location.origin}/.netlify/identity`
            });

            displayResults('identity-check', results);
        }

        // Test Git Gateway
        async function testGateway() {
            const results = [];

            try {
                const response = await fetch('/.netlify/git/info');
                results.push({
                    test: 'Git Gateway Response',
                    pass: response.status === 200 || response.status === 401,
                    details: `Status: ${response.status} (401 is expected if not authenticated)`
                });
            } catch (e) {
                results.push({
                    test: 'Git Gateway Response',
                    pass: false,
                    details: `Error: ${e.message}`
                });
            }

            displayResults('gateway-check', results);
        }

        // Test CMS Config
        async function testConfig() {
            const results = [];

            try {
                const response = await fetch('/admin/config.yml');
                const text = await response.text();

                results.push({
                    test: 'Config File Size',
                    pass: text.length > 100,
                    details: `Size: ${text.length} characters`
                });

                results.push({
                    test: 'Backend Configuration',
                    pass: text.includes('git-gateway'),
                    details: `Contains git-gateway: ${text.includes('git-gateway')}`
                });

                results.push({
                    test: 'Collections Defined',
                    pass: text.includes('collections:'),
                    details: `Contains collections: ${text.includes('collections:')}`
                });

            } catch (e) {
                results.push({
                    test: 'Config Parsing',
                    pass: false,
                    details: `Error: ${e.message}`
                });
            }

            displayResults('config-check', results);
        }

        function displayResults(elementId, results) {
            const html = results.map(result =>
                `<div class="test-result">
                    <span class="${result.pass ? 'pass' : 'fail'}">${result.pass ? '✅' : '❌'}</span>
                    <strong>${result.test}:</strong> ${result.details}
                </div>`
            ).join('');

            document.getElementById(elementId).innerHTML = html;
        }

        function clearAllCache() {
            // Clear various types of cache
            if ('caches' in window) {
                caches.keys().then(function(cacheNames) {
                    cacheNames.forEach(function(cacheName) {
                        caches.delete(cacheName);
                    });
                });
            }

            // Clear localStorage
            localStorage.clear();
            sessionStorage.clear();

            // Force reload
            setTimeout(() => {
                window.location.reload(true);
            }, 1000);

            alert('Cache cleared! Page will reload in 1 second...');
        }

        // Run all tests
        window.addEventListener('DOMContentLoaded', () => {
            testEnvironment();
            testFiles();
            testIdentity();
            testGateway();
            testConfig();
        });
    </script>
</body>
</html>