---
// 2025 Modern Properties Listing Page - Connected to CRM Database
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';

// Define proper types for CRM properties
interface Property {
  id: string;
  title: string;
  type: string;
  location: string;
  county: string;
  price: string;
  size: string;
  available: boolean;
  featured: boolean;
  description?: string;
  image?: string;
  gallery?: string[];
  features: string[];
  street_address?: string;
  city?: string;
  state?: string;
  zip_code?: string;
  lease_term?: string;
  clear_height?: string;
  loading_docks?: number;
  parking?: number;
  year_built?: number;
  created_at: string;
  updated_at: string;
}

// Get properties from CRM API
let allProperties: Property[] = [];
let availableProperties: Property[] = [];
let totalListings = 0;
let totalSqFt = 0;
let avgPrice = 0;

try {
  // Fetch properties from CRM API
  const response = await fetch('https://sbaycrm.netlify.app/api/public/properties?available=true');

  if (response.ok) {
    const data = await response.json();
    if (data.success) {
      allProperties = data.properties;
      availableProperties = allProperties.filter(p => p.available);
      totalListings = availableProperties.length;

      // Calculate total square footage and average price
      totalSqFt = availableProperties.reduce((sum, p) => {
        const size = parseInt(p.size?.replace(/[^0-9]/g, '') || '0');
        return sum + size;
      }, 0);

      // Calculate average price per square foot
      const prices = availableProperties
        .map(p => parseFloat(p.price?.replace(/[^0-9.-]/g, '') || '0'))
        .filter(price => price > 0);

      avgPrice = prices.length > 0 ?
        Math.round(prices.reduce((sum, price) => sum + price, 0) / prices.length * 100) / 100 : 0;
    }
  }
} catch (error) {
  console.log('Could not fetch CRM properties, using fallback data:', error);
}

// Market stats for data-driven feel
const marketStats = {
  totalListings: totalListings || 8,
  totalSqFt: totalSqFt || 250000,
  avgPrice: avgPrice || 12.50,
  newThisWeek: Math.min(totalListings, 3),
  avgDaysOnMarket: 45
};

// Filter options - these can be dynamically generated from CRM data
const locations = [
  'All Locations',
  'Miami-Dade County',
  'Broward County',
  'Palm Beach County',
  ...Array.from(new Set(availableProperties.map(p => p.location))).slice(0, 6)
];

const sizeRanges = [
  'Any Size',
  '1,000 - 5,000 SF',
  '5,000 - 20,000 SF',
  '20,000 - 50,000 SF',
  '50,000 - 100,000 SF',
  '100,000+ SF'
];

const propertyTypes = [
  'All Types',
  'Warehouse',
  'Office',
  'Industrial',
  'Flex Space',
  'Distribution'
];

const priceRanges = [
  'Any Price',
  '$5 - $8 /SF',
  '$8 - $12 /SF',
  '$12 - $15 /SF',
  '$15 - $20 /SF',
  '$20+ /SF'
];

// Helper function to format property type
function formatType(type: string): string {
  return type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// Helper function to format size
function formatSize(size: string): string {
  const numericSize = parseInt(size?.replace(/[^0-9]/g, '') || '0');
  return numericSize > 0 ? numericSize.toLocaleString() : size || 'Contact for details';
}

// Helper function to get property slug
function getPropertySlug(property: Property): string {
  return property.title?.toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .trim() || property.id;
}
---

<BaseLayout
  title="Warehouse Properties for Lease | Shallow Bay Advisors"
  description="Browse live warehouse inventory across South Florida. Filter by size, location, and property type. Book tours instantly for available properties."
>
  <Navigation />

  <!-- 2025 MODERN PROPERTIES PAGE -->
  <main class="pt-20">

    <!-- Page Header with Live Stats -->
    <section class="py-16 bg-neutral-50 border-b border-sba-gray-light">
      <div class="container mx-auto px-4">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-12">
          <div>
            <h1 class="text-4xl md:text-6xl font-black text-sba-navy leading-tight tracking-tighter mb-4">
              WAREHOUSE
              <span class="block gradient-sba">PROPERTIES</span>
            </h1>
            <p class="text-xl text-sba-gray-dark max-w-2xl">
              Live inventory from our CRM across South Florida's premier industrial markets
            </p>
          </div>

          <!-- Live Market Stats -->
          <div class="mt-8 lg:mt-0">
            <div class="glass border border-sba-gray-light rounded-2xl p-6">
              <div class="grid grid-cols-2 gap-6 text-center">
                <div>
                  <div class="text-2xl font-mono font-black text-sba-navy">{marketStats.totalListings}</div>
                  <div class="text-xs text-sba-gray uppercase tracking-wider font-semibold">Live Listings</div>
                </div>
                <div>
                  <div class="text-2xl font-mono font-black text-sba-navy">{(marketStats.totalSqFt / 1000000).toFixed(1)}M</div>
                  <div class="text-xs text-sba-gray uppercase tracking-wider font-semibold">Total SF</div>
                </div>
                <div>
                  <div class="text-2xl font-mono font-black text-accent-blue">${marketStats.avgPrice}</div>
                  <div class="text-xs text-sba-gray uppercase tracking-wider font-semibold">Avg/SF</div>
                </div>
                <div>
                  <div class="text-2xl font-mono font-black text-accent-green">+{marketStats.newThisWeek}</div>
                  <div class="text-xs text-sba-gray uppercase tracking-wider font-semibold">New This Week</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Filters Section -->
    <section class="py-12 bg-white sticky top-20 z-40 border-b border-sba-gray-light">
      <div class="container mx-auto px-4">
        <form id="property-filters" class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <!-- Location Filter -->
          <div>
            <label class="block text-sm font-bold text-sba-navy mb-2 uppercase tracking-wider">Location</label>
            <select name="location" class="w-full h-12 bg-white border-2 border-sba-gray-light rounded-xl text-sba-navy px-4 focus:border-sba-navy focus:ring-0 focus:outline-none transition-all duration-200 font-semibold">
              {locations.map(location => (
                <option value={location}>{location}</option>
              ))}
            </select>
          </div>

          <!-- Size Filter -->
          <div>
            <label class="block text-sm font-bold text-sba-navy mb-2 uppercase tracking-wider">Size</label>
            <select name="size" class="w-full h-12 bg-white border-2 border-sba-gray-light rounded-xl text-sba-navy px-4 focus:border-sba-navy focus:ring-0 focus:outline-none transition-all duration-200 font-semibold">
              {sizeRanges.map(range => (
                <option value={range}>{range}</option>
              ))}
            </select>
          </div>

          <!-- Type Filter -->
          <div>
            <label class="block text-sm font-bold text-sba-navy mb-2 uppercase tracking-wider">Type</label>
            <select name="type" class="w-full h-12 bg-white border-2 border-sba-gray-light rounded-xl text-sba-navy px-4 focus:border-sba-navy focus:ring-0 focus:outline-none transition-all duration-200 font-semibold">
              {propertyTypes.map(type => (
                <option value={type}>{type}</option>
              ))}
            </select>
          </div>

          <!-- Price Filter -->
          <div>
            <label class="block text-sm font-bold text-sba-navy mb-2 uppercase tracking-wider">Price</label>
            <select name="price" class="w-full h-12 bg-white border-2 border-sba-gray-light rounded-xl text-sba-navy px-4 focus:border-sba-navy focus:ring-0 focus:outline-none transition-all duration-200 font-semibold">
              {priceRanges.map(range => (
                <option value={range}>{range}</option>
              ))}
            </select>
          </div>

          <!-- Search Button -->
          <div class="flex items-end">
            <button type="submit" class="btn-primary rounded-xl w-full h-12 text-sm hover:shadow-lg transform hover:scale-105 transition-all duration-300">
              FILTER
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- Properties Grid -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">

        <!-- Results Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-12">
          <div>
            <h2 class="text-2xl font-black text-sba-navy mb-2">
              SHOWING {availableProperties.length} PROPERTIES
            </h2>
            <p class="text-sba-gray-dark">Live from our CRM database</p>
          </div>

          <!-- Sort Options -->
          <div class="mt-4 sm:mt-0">
            <select id="sort-select" class="bg-white border-2 border-sba-gray-light rounded-xl text-sba-navy px-4 py-2 focus:border-sba-navy focus:ring-0 focus:outline-none transition-all duration-200 font-semibold">
              <option value="newest">Newest First</option>
              <option value="price-low">Price: Low to High</option>
              <option value="price-high">Price: High to Low</option>
              <option value="size-small">Size: Smallest First</option>
              <option value="size-large">Size: Largest First</option>
            </select>
          </div>
        </div>

        <!-- Properties Grid -->
        {availableProperties.length > 0 ? (
          <div class="grid grid-cols-property gap-8 mb-16">
            {availableProperties.map((property, index) => (
              <div class="card group overflow-hidden animate-fade-in" style={`animation-delay: ${index * 0.05}s;`}>
                {property.image && (
                  <div class="aspect-property overflow-hidden bg-neutral-100 relative">
                    <img
                      src={property.image}
                      alt={property.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                      loading="lazy"
                    />
                    <!-- Property Status Badge -->
                    <div class="absolute top-4 left-4">
                      <span class="bg-success-500 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider">
                        {property.available ? 'Available' : 'Leased'}
                      </span>
                      {property.featured && (
                        <span class="bg-accent-blue text-white px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider ml-2">
                          Featured
                        </span>
                      )}
                    </div>
                    <!-- Size Badge -->
                    <div class="absolute top-4 right-4">
                      <span class="bg-black/80 text-white px-3 py-1 rounded-lg text-xs font-mono font-bold backdrop-blur-sm">
                        {formatSize(property.size)} SF
                      </span>
                    </div>
                  </div>
                )}

                <div class="p-6">
                  <!-- Property Header -->
                  <div class="mb-6">
                    <h3 class="text-xl font-black text-sba-navy mb-2 leading-tight group-hover:text-sba-navy-dark transition-colors duration-200">
                      {property.title}
                    </h3>
                    <p class="text-sba-gray-dark font-mono text-sm uppercase tracking-wider">
                      {property.location} • {property.county}
                    </p>
                    <p class="text-sba-gray text-xs uppercase tracking-wider">
                      {formatType(property.type)}
                    </p>
                  </div>

                  <!-- Key Stats -->
                  <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="text-center p-4 bg-sba-gray-light/20 rounded-xl">
                      <div class="text-2xl font-black text-sba-navy">{property.price}</div>
                      <div class="text-xs text-sba-gray uppercase tracking-wider font-semibold">Per SF/Year</div>
                    </div>
                    <div class="text-center p-4 bg-sba-gray-light/20 rounded-xl">
                      <div class="text-2xl font-black text-sba-navy">{formatSize(property.size)}</div>
                      <div class="text-xs text-sba-gray uppercase tracking-wider font-semibold">Square Feet</div>
                    </div>
                  </div>

                  <!-- Additional Details -->
                  {(property.clear_height || property.loading_docks || property.parking) && (
                    <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                      {property.clear_height && (
                        <div class="bg-neutral-50 p-2 rounded-lg">
                          <div class="text-sm font-bold text-sba-navy">{property.clear_height}</div>
                          <div class="text-xs text-sba-gray">Height</div>
                        </div>
                      )}
                      {property.loading_docks && property.loading_docks > 0 && (
                        <div class="bg-neutral-50 p-2 rounded-lg">
                          <div class="text-sm font-bold text-sba-navy">{property.loading_docks}</div>
                          <div class="text-xs text-sba-gray">Docks</div>
                        </div>
                      )}
                      {property.parking && property.parking > 0 && (
                        <div class="bg-neutral-50 p-2 rounded-lg">
                          <div class="text-sm font-bold text-sba-navy">{property.parking}</div>
                          <div class="text-xs text-sba-gray">Parking</div>
                        </div>
                      )}
                    </div>
                  )}

                  <!-- Features -->
                  {property.features && property.features.length > 0 && (
                    <div class="mb-6">
                      <div class="flex flex-wrap gap-2">
                        {property.features.slice(0, 3).map(feature => (
                          <span class="bg-sba-gray-light/30 text-sba-gray-dark px-3 py-1 rounded-lg text-xs font-semibold uppercase tracking-wider">
                            {feature}
                          </span>
                        ))}
                        {property.features.length > 3 && (
                          <span class="text-sba-gray text-xs font-semibold">
                            +{property.features.length - 3} more
                          </span>
                        )}
                      </div>
                    </div>
                  )}

                  <!-- Description -->
                  {property.description && (
                    <p class="text-sba-gray-dark text-sm leading-relaxed mb-6 line-clamp-2">
                      {property.description}
                    </p>
                  )}

                  <!-- Actions -->
                  <div class="grid grid-cols-2 gap-3">
                    <a
                      href={`/properties/${getPropertySlug(property)}`}
                      class="btn-ghost rounded-xl text-center py-3 text-sm hover:shadow-lg transition-all duration-200"
                    >
                      VIEW DETAILS
                    </a>
                    <a
                      href="/book-appointment"
                      class="btn-primary rounded-xl py-3 text-sm hover:shadow-lg transition-all duration-200 text-center"
                    >
                      BOOK TOUR
                    </a>
                  </div>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <!-- No Results State -->
          <div class="text-center py-20">
            <div class="w-20 h-20 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
              <svg class="w-10 h-10 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
            </div>
            <h3 class="text-2xl font-bold text-black mb-4">No Properties Found</h3>
            <p class="text-neutral-600 mb-8 max-w-md mx-auto">
              Add some properties to your CRM to see them displayed here, or contact us for off-market opportunities.
            </p>
            <a href="/book-appointment" class="btn-primary rounded-xl px-8 py-4 hover:shadow-lg transform hover:scale-105 transition-all duration-300">
              SCHEDULE CONSULTATION
            </a>
          </div>
        )}

        <!-- CRM Connection Status -->
        <div class="text-center mt-12">
          <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg text-sm font-medium">
            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
            Live data from CRM • Last updated: {new Date().toLocaleTimeString()}
          </div>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="py-20 bg-sba-navy text-white">
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-4xl md:text-6xl font-black leading-tight tracking-tighter mb-6">
          CAN'T FIND WHAT
          <span class="block text-sba-gray">YOU'RE LOOKING FOR?</span>
        </h2>
        <p class="text-xl text-sba-gray-light max-w-2xl mx-auto mb-12">
          We have exclusive access to off-market properties and can help you find exactly what you need.
        </p>

        <div class="flex flex-col sm:flex-row gap-6 justify-center items-center">
          <a href="/contact" class="bg-white text-sba-navy rounded-xl text-lg px-12 py-4 font-semibold hover:shadow-xl transform hover:scale-105 transition-all duration-300">
            CONTACT OUR TEAM
          </a>
          <div class="flex items-center gap-4 text-sba-gray">
            <span class="w-px h-8 bg-sba-gray"></span>
            <span class="text-sm uppercase tracking-wider">OR</span>
            <span class="w-px h-8 bg-sba-gray"></span>
          </div>
          <a href="/book-appointment" class="text-white font-semibold text-lg hover:text-sba-gray-light transition-colors duration-200">
            Schedule Consultation
          </a>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</BaseLayout>

<style>
  /* Form select styling */
  select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%231e3a5f' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 12px center;
    background-repeat: no-repeat;
    background-size: 16px 16px;
    padding-right: 40px;
    appearance: none;
  }

  /* Text clamp utility */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Animation delays */
  .animate-fade-in {
    animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Filter form handling - would connect to CRM API
    const filterForm = document.getElementById('property-filters');
    if (filterForm) {
      filterForm.addEventListener('change', function() {
        console.log('Filters changed - would update CRM API call');
        // In a real implementation, this would make a new API call with filters
      });
    }

    // Sort functionality - would connect to CRM API
    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) {
      sortSelect.addEventListener('change', function() {
        console.log('Sort changed to:', this.value);
        // In a real implementation, this would re-sort via API
      });
    }
  });
</script>